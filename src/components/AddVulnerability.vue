<template>
  <a-modal
    :open="props.visible"
    title="â•æ·»åŠ æ¼æ´â•"
    width="850px"
    :footer="null"
    destroy-on-close
    @cancel="emit('update:visible', false)"
  >
    <a-tabs v-model:activeKey="activeKey">
      <a-tab-pane key="1" tab="â˜£ï¸æ·»åŠ æ¼æ´">
        <a-form :model="modelRef" layout="vertical">
          <a-form-item label="ğŸ«æ¼æ´åç§°" v-bind="validateInfos.vuln_name">
            <a-input v-model:value="modelRef.vuln_name" placeholder="æ¼æ´åç§°" allow-clear />
          </a-form-item>

          <a-form-item label="ğŸ«æ¼æ´æè¿°" v-bind="validateInfos.vuln_description">
            <a-textarea
              v-model:value="modelRef.vuln_description"
              placeholder="æ¼æ´æè¿°"
              :rows="4"
            />
          </a-form-item>

          <a-form-item label="ğŸ«é€ æˆå½±å“" v-bind="validateInfos.affects_type">
            <a-textarea
                v-model:value="modelRef.affects_type"
                placeholder="é€ æˆå½±å“"
                :rows="4"
            />
          </a-form-item>

          <a-form-item label="ğŸ«ä¿®å¤å»ºè®®" v-bind="validateInfos.fix_suggestion">
            <a-textarea
              v-model:value="modelRef.fix_suggestion"
              placeholder="ä¿®å¤å»ºè®®"
              :rows="4"
            />
          </a-form-item>

          <div style="text-align: right; margin-top: 20px">
            <a-button @click="emit('update:visible', false)" style="margin-right: 8px">
              å–æ¶ˆ
            </a-button>
            <a-button type="primary" @click="handleSave">ä¿å­˜</a-button>
          </div>
        </a-form>
      </a-tab-pane>

      <a-tab-pane key="2" tab="ğŸ’©æŸ¥çœ‹æ¼æ´">
        <QueryVulnerabilityInfo />
      </a-tab-pane>
    </a-tabs>
  </a-modal>
</template>

<script setup lang="ts">
import { ref, watch, reactive } from 'vue'
import { Form } from 'ant-design-vue'
import { notification } from 'ant-design-vue'
import { invoke } from '@tauri-apps/api/core'
import QueryVulnerabilityInfo from './QueryVulnerabilityInfo.vue'

const props = defineProps<{ visible: boolean }>()
const emit = defineEmits<{ (e: 'update:visible', value: boolean): void }>()

// è¡¨å•çŠ¶æ€
const modelRef = reactive({
  vuln_name: '',
  vuln_description: '',
  fix_suggestion: '',
  affects_type: ''
})

// æ¯æ¬¡æ‰“å¼€ modal å¼ºåˆ¶å›åˆ°â€œæ·»åŠ æ¼æ´â€tabï¼Œå¹¶æ¸…ç©ºè¡¨å•
const activeKey = ref('1')
watch(() => props.visible, (val) => {
  if (val) {
    activeKey.value = '1'
    resetFields()
  }
}, { immediate: true })

// ä½¿ç”¨ useForm ç»‘å®šè¡¨å•æ ¡éªŒ
const { resetFields, validate, validateInfos } = Form.useForm(modelRef, {
  vuln_name: [{ required: true, message: 'è¯·è¾“å…¥æ¼æ´åç§°' }],
  vuln_description: [{ required: true, message: 'è¯·è¾“å…¥æ¼æ´æè¿°' }],
  affects_type: [{ required: true, message: 'è¯·è¾“å…¥é€ æˆå±å®³' }],
  fix_suggestion: [{ required: true, message: 'è¯·è¾“å…¥ä¿®å¤å»ºè®®' }],
})

// ä¿å­˜é€»è¾‘
const handleSave = async () => {
  console.log('ç‚¹å‡»ä¿å­˜æŒ‰é’®')
  try {
    await validate()
    console.log('å‰ç«¯ä¼ é€’çš„å‚æ•°:', { ...modelRef })
    await invoke('add_vulnerability', {
      vulnName: modelRef.vuln_name, 
      vulnDescription: modelRef.vuln_description,
      fixSuggestion: modelRef.fix_suggestion,
      affectsType: modelRef.affects_type
    })

    notification.success({ message: 'æ¼æ´æ·»åŠ æˆåŠŸï¼' })
    resetFields()
    emit('update:visible', false)
  } catch (err) {
    console.error('ä¿å­˜å¤±è´¥', err)
  }
}
</script>

<style scoped>
:deep(.ant-modal-body) {
  max-height: 70vh;
  overflow-y: auto;
}
</style>