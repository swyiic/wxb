<template>
  <a-modal v-show="showAddVulnerability" style="width: 750px; height: 200px;" title="â•æ·»åŠ æ¼æ´â•"
    :visible="showAddVulnerabilityVisible" :footer="null" @cancel="handleCancel">
    <a-tabs default-active-key="1" @change="handleTabChange">
      <a-tab-pane key="1" tab="â˜£ï¸æ·»åŠ æ¼æ´">
        <a-form :model="modelRef">
          <a-form-item label="ğŸ«æ¼æ´åç§°" v-bind="validateInfos.vuln_name">
            <a-input v-model:value="modelRef.vuln_name" placeholder="æ¼æ´åç§°" allow-clear />
          </a-form-item>
          <a-form-item label="ğŸ«æ¼æ´æè¿°" v-bind="validateInfos.vuln_description">
            <a-textarea v-model:value="modelRef.vuln_description" placeholder="æ¼æ´æè¿°" :rows="4" />
          </a-form-item>
          <a-form-item label="ğŸ«ä¿®å¤å»ºè®®" v-bind="validateInfos.fix_suggestion">
            <a-textarea v-model:value="modelRef.fix_suggestion" placeholder="ä¿®å¤å»ºè®®" :rows="4" />
          </a-form-item>
          <div style="text-align: right; margin-top: 16px;">
            <a-button @click="handleCancel" style="margin-right: 8px;">å–æ¶ˆ</a-button>
            <a-button type="primary" @click="handleSave">ä¿å­˜</a-button>
          </div>
        </a-form>
      </a-tab-pane>
      <a-tab-pane key="2" tab="ğŸ’©å·²æœ‰æ¼æ´" force-render>
        <QueryVulnerabilityInfo :key="uniqueKey" />
      </a-tab-pane>
    </a-tabs>
  </a-modal>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from 'vue'
import { listen } from '@tauri-apps/api/event'
import { invoke } from '@tauri-apps/api/tauri';
import { reactive } from 'vue';
import { Form } from 'ant-design-vue';
import { notification } from 'ant-design-vue';
import QueryVulnerabilityInfo from './QueryVulnerabilityInfo.vue';
import { eventBus } from '../eventBus';

const openNotificationWithIcon = (type: 'success' | 'info' | 'warning' | 'error') => {
  notification[type]({
    message: 'æ¼æ´æ·»åŠ æˆåŠŸ'
  });
};
const useForm = Form.useForm;
const showAddVulnerability = ref(false)
const showAddVulnerabilityVisible = ref(false)

//ä¸€å®¶äºº è‰æ³¥é©¬ï¼Œå¼ºåˆ¶åˆ·æ–°å­ç»„ä»¶ è ¢é©´
const activeKey = ref('1');
const uniqueKey = ref(Date.now());
watch(activeKey, (newValue) => {
  if (newValue === '2') {
    uniqueKey.value = Date.now(); // åˆ‡æ¢åˆ° tab 2 æ—¶æ›´æ–° key
  }
});
const handleTabChange = (key:string) => {
  activeKey.value = key;
};

//ç¦»è¿œç‚¹
const modelRef = reactive({
  vuln_name: '',
  vuln_description: '',
  fix_suggestion: ''
});

const { validate, validateInfos, resetFields } = useForm(
  modelRef,
  reactive({
    vuln_name: [
      {
        required: true,
        message: 'è¯·è¾“å…¥æ¼æ´åç§°',
      },
    ],
    vuln_description: [
      {
        required: true,
        message: 'è¯·è¾“å…¥æ¼æ´æè¿°',
      },
    ],
    fix_suggestion: [
      {
        required: true,
        message: 'è¯·è¾“å…¥ä¿®å¤å»ºè®®',
      },
    ],
  }),
);


onMounted(() => {
  listen('show_add_vulnerability', () => {
    resetForm();  // æ¯æ¬¡æ‰“å¼€æ¨¡æ€æ¡†å‰é‡ç½®è¡¨å•
    showAddVulnerability.value = true
    showAddVulnerabilityVisible.value = true
  })
})

const resetForm = () => {
  resetFields(); // é‡ç½®è¡¨å•æ•°æ®å’ŒéªŒè¯çŠ¶æ€
  modelRef.vuln_name = '';
  modelRef.vuln_description = '';
  modelRef.fix_suggestion = '';
};

const handleCancel = () => {
  resetForm(); // é‡ç½®è¡¨å•æ•°æ®
  showAddVulnerabilityVisible.value = false;
};


const handleSave = async () => {
  try {
    await validate()
      .then(() => {
        // resetForm(); // æˆåŠŸä¿å­˜åé‡ç½®è¡¨å•æ•°æ®
        openNotificationWithIcon('success');
        eventBus.emit('data-update');
        showAddVulnerabilityVisible.value = false;
      })
      .catch(err => {
        console.log('éªŒè¯å¤±è´¥:', err);
      });

    await invoke('add_vulnerability', {
      vulnName: modelRef.vuln_name,
      vulnDescription: modelRef.vuln_description,
      fixSuggestion: modelRef.fix_suggestion,
    });
    console.log('ä¿å­˜æˆåŠŸ');
  } catch (err) {
    console.error('è°ƒç”¨åç«¯å‘½ä»¤å¤±è´¥:', err);
  }
};

</script>
