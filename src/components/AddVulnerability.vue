<template>
  <a-modal v-show="showAddVulnerability" style="width: 750px; height: 200px;" title="➕添加漏洞➕"
    :visible="showAddVulnerabilityVisible" :footer="null" @cancel="handleCancel">
    <a-tabs default-active-key="1" @change="handleTabChange">
      <a-tab-pane key="1" tab="☣️添加漏洞">
        <a-form :model="modelRef">
          <a-form-item label="🫏漏洞名称" v-bind="validateInfos.vuln_name">
            <a-input v-model:value="modelRef.vuln_name" placeholder="漏洞名称" allow-clear />
          </a-form-item>
          <a-form-item label="🫏漏洞描述" v-bind="validateInfos.vuln_description">
            <a-textarea v-model:value="modelRef.vuln_description" placeholder="漏洞描述" :rows="4" />
          </a-form-item>
          <a-form-item label="🫏修复建议" v-bind="validateInfos.fix_suggestion">
            <a-textarea v-model:value="modelRef.fix_suggestion" placeholder="修复建议" :rows="4" />
          </a-form-item>
          <div style="text-align: right; margin-top: 16px;">
            <a-button @click="handleCancel" style="margin-right: 8px;">取消</a-button>
            <a-button type="primary" @click="handleSave">保存</a-button>
          </div>
        </a-form>
      </a-tab-pane>
      <a-tab-pane key="2" tab="💩已有漏洞" force-render>
        <QueryVulnerabilityInfo :key="uniqueKey" />
      </a-tab-pane>
    </a-tabs>
  </a-modal>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from 'vue'
import { listen } from '@tauri-apps/api/event'
import { invoke } from '@tauri-apps/api/tauri';
import { reactive } from 'vue';
import { Form } from 'ant-design-vue';
import { notification } from 'ant-design-vue';
import QueryVulnerabilityInfo from './QueryVulnerabilityInfo.vue';
import { eventBus } from '../eventBus';

const openNotificationWithIcon = (type: 'success' | 'info' | 'warning' | 'error') => {
  notification[type]({
    message: '漏洞添加成功'
  });
};
const useForm = Form.useForm;
const showAddVulnerability = ref(false)
const showAddVulnerabilityVisible = ref(false)

//一家人 草泥马，强制刷新子组件 蠢驴
const activeKey = ref('1');
const uniqueKey = ref(Date.now());
watch(activeKey, (newValue) => {
  if (newValue === '2') {
    uniqueKey.value = Date.now(); // 切换到 tab 2 时更新 key
  }
});
const handleTabChange = (key:string) => {
  activeKey.value = key;
};

//离远点
const modelRef = reactive({
  vuln_name: '',
  vuln_description: '',
  fix_suggestion: ''
});

const { validate, validateInfos, resetFields } = useForm(
  modelRef,
  reactive({
    vuln_name: [
      {
        required: true,
        message: '请输入漏洞名称',
      },
    ],
    vuln_description: [
      {
        required: true,
        message: '请输入漏洞描述',
      },
    ],
    fix_suggestion: [
      {
        required: true,
        message: '请输入修复建议',
      },
    ],
  }),
);


onMounted(() => {
  listen('show_add_vulnerability', () => {
    resetForm();  // 每次打开模态框前重置表单
    showAddVulnerability.value = true
    showAddVulnerabilityVisible.value = true
  })
})

const resetForm = () => {
  resetFields(); // 重置表单数据和验证状态
  modelRef.vuln_name = '';
  modelRef.vuln_description = '';
  modelRef.fix_suggestion = '';
};

const handleCancel = () => {
  resetForm(); // 重置表单数据
  showAddVulnerabilityVisible.value = false;
};


const handleSave = async () => {
  try {
    await validate()
      .then(() => {
        // resetForm(); // 成功保存后重置表单数据
        openNotificationWithIcon('success');
        eventBus.emit('data-update');
        showAddVulnerabilityVisible.value = false;
      })
      .catch(err => {
        console.log('验证失败:', err);
      });

    await invoke('add_vulnerability', {
      vulnName: modelRef.vuln_name,
      vulnDescription: modelRef.vuln_description,
      fixSuggestion: modelRef.fix_suggestion,
    });
    console.log('保存成功');
  } catch (err) {
    console.error('调用后端命令失败:', err);
  }
};

</script>
