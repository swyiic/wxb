<template>
  <a-table
    :columns="columns"
    :data-source="dataSource"
    :scroll="{ x: 1400 }"
    bordered
    size="middle"
  >
    <template #bodyCell="{ column, text, record }">
      <!-- 漏洞详情 / 造成危害 / 修复建议（长文本列） -->
      <template
        v-if="
          ['vuln_description', 'affects_type', 'fix_suggestion'].includes(
            column.dataIndex
          )
        "
      >
        <a-tooltip placement="topLeft">
          <template #title>
            <pre style="margin: 0; white-space: pre-wrap; max-width: 600px">{{
              text || "-"
            }}</pre>
          </template>

          <div class="editable-cell">
            <a-textarea
              v-if="editableData[record.id]"
              v-model:value="editableData[record.id][column.dataIndex as keyof DataItem]"
              :auto-size="{ minRows: 2, maxRows: 8 }"
              class="ghost-textarea"
              placeholder="请输入内容..."
            />
            <div v-else class="cell-text">
              {{ text || "-" }}
            </div>
          </div>
        </a-tooltip>
      </template>

      <!-- 漏洞名称（单行输入） -->
      <template v-else-if="column.dataIndex === 'vuln_name'">
        <div class="editable-cell">
          <a-input
            v-if="editableData[record.id]"
            v-model:value="editableData[record.id].vuln_name"
            class="ghost-input"
            placeholder="请输入漏洞名称"
          />
          <div v-else class="cell-text">
            {{ text }}
          </div>
        </div>
      </template>

      <!-- 操作列：垂直排列 + 文字完整显示 + 超紧凑美观 -->
      <template v-else-if="column.dataIndex === 'operation'">
        <div class="operation-cell-vertical">
          <span v-if="editableData[record.id]">
            <!-- 保存 -->
            <a-tooltip title="保存修改">
              <a-button type="primary" class="op-btn" @click="save(record.id)">
                保存
              </a-button>
            </a-tooltip>

            <!-- 取消 -->
            <a-tooltip title="取消编辑">
              <a-button class="op-btn cancel-btn" @click="cancel(record.id)">
                取消
              </a-button>
            </a-tooltip>

            <!-- 删除 -->
            <a-popconfirm
              title="确定删除这条漏洞吗？"
              ok-text="删除"
              cancel-text="取消"
              @confirm="deleteItem(record.id)"
            >
              <a-tooltip title="删除此漏洞">
                <a-button type="primary" danger class="op-btn"> 删除 </a-button>
              </a-tooltip>
            </a-popconfirm>
          </span>

          <span v-else>
            <!-- 编辑 -->
            <a-tooltip title="编辑此漏洞">
              <a-button type="primary" class="op-btn" @click="edit(record.id)">
                编辑
              </a-button>
            </a-tooltip>
          </span>
        </div>
      </template>
    </template>
  </a-table>
</template>

<script lang="ts" setup>
import { reactive, ref, onMounted } from "vue";
import { listen } from "@tauri-apps/api/event";
import { invoke } from "@tauri-apps/api/core";
import { eventBus } from "../eventBus";
// import { EditOutlined, DeleteOutlined } from "@ant-design/icons-vue";

const columns = [
  { title: "漏洞名称", dataIndex: "vuln_name", width: 180 },
  { title: "漏洞详情", dataIndex: "vuln_description" },
  { title: "造成危害", dataIndex: "affects_type" },
  { title: "修复建议", dataIndex: "fix_suggestion" },
  { title: "操作", dataIndex: "operation", width: 80, fixed: "right" },
] as const;

interface DataItem {
  id: number;
  vuln_name: string;
  vuln_description: string;
  fix_suggestion: string;
  affects_type: string;
}

const dataSource = ref<DataItem[]>([]);
const editableData = reactive<Record<number, DataItem>>({});

const queryVulnerabilities = async () => {
  try {
    const vulnerabilities = (await invoke(
      "query_all_vulnerability"
    )) as DataItem[];
    dataSource.value = vulnerabilities;
    // 清空所有编辑状态
    Object.keys(editableData).forEach((key) => delete editableData[+key]);
  } catch (e) {
    console.error("查询漏洞失败:", e);
  }
};

onMounted(() => {
  eventBus.on("data-update", queryVulnerabilities);
  listen("data-update", queryVulnerabilities);
  queryVulnerabilities();
  listen("query_all_vulnerability", queryVulnerabilities);
});

const edit = (id: number) => {
  const item = dataSource.value.find((i) => i.id === id);
  if (item) {
    editableData[id] = { ...item };
  }
};

const save = async (id: number) => {
  const edited = editableData[id];
  if (!edited) return;

  try {
    await invoke("edit_vulnerability", {
      id,
      vulnName: edited.vuln_name,
      vulnDescription: edited.vuln_description,
      fixSuggestion: edited.fix_suggestion,
      affectsType: edited.affects_type,
    });
    delete editableData[id];
    await queryVulnerabilities();
  } catch (e) {
    console.error("保存失败:", e);
  }
};

const cancel = (id: number) => {
  delete editableData[id];
};

const deleteItem = async (id: number) => {
  try {
    await invoke("delete_vulnerability", { id });
    await queryVulnerabilities();
  } catch (e) {
    console.error("删除失败:", e);
  }
};
</script>

<style scoped>
/* 编辑态美化：像 Notion 一样舒服 */
.editable-cell {
  min-height: 32px;
  padding: 4px 0;
}

.ghost-input,
.ghost-textarea {
  background: rgba(255, 193, 7, 0.08) !important;
  border: 1px solid rgba(255, 193, 7, 0.4) !important;
  border-radius: 6px !important;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06) !important;
  transition: all 0.2s ease !important;
}

.ghost-input:focus,
.ghost-textarea:focus {
  background: rgba(255, 193, 7, 0.15) !important;
  border-color: #ffc107 !important;
  box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2) !important;
}

.cell-text {
  padding: 4px 0;
  line-height: 1.5;
  white-space: pre-wrap;
  word-break: break-word;
}

.operation-cell-vertical {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 4px 0;
}

.cancel-btn:hover {
  background: #e6e6e6;
  border-color: #bfbfbf;
}

:deep(.ant-table-tbody > tr > td) {
  padding: 12px 16px !important;
}

:deep(.ant-table-tbody > tr:hover > td) {
  background: #fafafa !important;
}

:deep(.op-btn .ant-btn) {
  width: 56px !important; /* 56px 足够放下“保存”“删除”两个字 */
  min-width: 56px !important; /* 强制覆盖 AntD 默认 min-width: 80px */
  height: 28px !important;
  padding: 0 8px !important;
  font-size: 12px !important;
  line-height: 26px !important;
  display: flex;
  align-items: center;
  justify-content: center;
}
:deep(.cancel-btn .ant-btn) {
  background: #fafafa !important;
  border-color: #d9d9d9 !important;
  color: #666 !important;
}
</style>
